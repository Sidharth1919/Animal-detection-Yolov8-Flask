{% extends 'base.html' %}

{% block body %}

<!-- create farm -->

<form class="container border border-dark rounded my-5 p-5" method="post" action="{{ url_for('farm')  }}">
  <h1 class="text-center">Surveillance  footage</h1>
  <div class="mb-3 mt-3">
    <label for="ip" class="form-label">Select video source:</label>
    <div class="form-control" style="border: none; padding: 0;">
      <div class="form-check">
        <input type="radio" id="webcam" name="ip" value="0" class="form-check-input">
        <label for="webcam" class="form-check-label">Webcam</label>
      </div>
      <div class="form-check">
        <input type="radio" id="localFile" name="ip" value="1" class="form-check-input">
        <label for="localFile" class="form-check-label">Local file</label>
      </div>
    </div>
  </div>
  <button type="submit" class="btn btn-dark" value="submit" id="btn1">Start</button>
  <button type="button" class="btn btn-dark" id="btn3" onclick="hidefeed()">Hide Video</button>
  <button type="button" class="btn btn-dark" id="btn2" onclick="stopfeed()">Kill Process</button>
</form>

<!-- real-time data display -->

<div class="container border border-dark rounded my-5 p-5 text-center" id="todocont">

  <!-- real-time animal-counting -->

  <h1 class="mt-5">Data</h1>

  <table class="table table-hover">
    <thead>
      <tr>
        <th>Video Source</th>
        <th>Farm</th>
        <th>Detections</th>
        <th id="animal">Number Of Animals in Farm</th>
        <th>Threat detected</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ ip_address }}</td>
        <td id="farm">none selected</td>
        <td id="type">none</td>
        <td id="count">0</td>
        <td id="threat">none</td>
      </tr>
    </tbody>
  </table>

  <!-- real-time video-feed -->

  <h1 class="mt-5">{{ var2 }}</h1>

  {% if ip_address %}
  <!-- <img class="mt-3 rounded" src="{{ url_for('video_feed')}}" id="videoFeed" alt="cctvfotage" width="50%"> -->
  <img class="mt-3 rounded" src="{{ url_for('video_feed', ip=ip_address)}}" id="videoFeed" alt="cctvfotage" width="50%">
  {% endif %}

</div>

<script>
  // Farm value from index.html
  window.onload = function() {
      // Retrieve selected farm from local storage
      const selectedFarm = localStorage.getItem('selectedFarm');

      // Update the table cell
      if (selectedFarm) {
        document.getElementById('farm').textContent = selectedFarm;

      // Update the table heading
      const tableHeading = document.getElementById('animal');
      if (tableHeading) { 
        tableHeading.textContent = `Number Of ${selectedFarm}'s in Farm`;
      }

        // Optionally clear local storage after use
        // localStorage.removeItem('selectedFarm'); 
      }
    };

  // Showing or Hiding video-feed

  function hidefeed() {
    var live_feed = document.getElementById('videoFeed')
    var btn3 = document.getElementById('btn3')

    if (live_feed.style.display == "none") {
      live_feed.style.display = "block";
      live_feed.style.marginLeft = "auto";
      live_feed.style.marginRight = "auto"
      btn3.innerHTML = "Hide Video"
    }
    else {
      live_feed.style.display = "none";
      btn3.innerHTML = "Show Video"
    }
  }

  // to stoplive feed / kill the opencv process

  function stopfeed() {

    fetch('/stop_feed')
      .then(response => {
        if (response.ok) {
          console.log('feed stopped!')
        }
        else {
          console.log('error stopping feed!')
        }
      })
      .catch(error => {
        console.log('Error stopping feed: ', error)
      })

  }

// ajax requesting for lve count
var ip_address = "{{ ip_address }}"; // Ensure this gets the value from Flask

function updatecount() {
  // Check if ip_address is 0 or 1, indicating the video is on
  if (ip_address == "0" || ip_address == "1") {
    // Only then, send AJAX requests to update count, type, and threat
    var xhttpCount = new XMLHttpRequest();
    xhttpCount.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        document.getElementById('count').innerHTML = this.responseText;
      }
    };
    xhttpCount.open('GET', '/count', true);
    xhttpCount.send();

    var xhttpType = new XMLHttpRequest();
    xhttpType.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        document.getElementById('type').innerHTML = this.responseText;
      }
    };
    xhttpType.open('GET', '/type', true);
    xhttpType.send();

    var xhttpThreat = new XMLHttpRequest();
    xhttpThreat.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        document.getElementById('threat').innerHTML = this.responseText;
      }
    };
    xhttpThreat.open('GET', '/threat', true);
    xhttpThreat.send();
  } else {
    // If the video is off, you might want to reset or handle the display of count, type, and threat differently
    console.log("Video is off. No updates to count, type, or threat.");
  }
    // Update the video feed source with the IP address

    var videoFeed = document.getElementById('videoFeed');
    if (videoFeed) {
      videoFeed.src = "{{ url_for('video_feed', ip=ip_address)}}";
    }
}

// Call updatecount every 500 milliseconds (0.5 seconds)
setInterval(updatecount, 500);
</script>

{% endblock body %}