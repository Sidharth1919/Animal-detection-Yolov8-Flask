{% extends 'base.html' %}

{% block body %}

<head>
  <link rel="stylesheet" type="text/css" href="../static/style.css">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<!-- create farm -->
<img src="" id="bgimg">

<form class="border border-dark p-2" method="post" action="{{ url_for('farm') }}"
  style="background-color: rgb(237, 243, 243);">
  <div style="display: flex; flex-direction: row;">
    <div style="width: 50vw; align-content: center;" >
      <h1 style="font-weight: bold; font-size:8vh; color: rgb(7, 59, 58);" id="heading" class="text-center">Farm</h1>
    </div>

    <div class="fullform">
      <div class="form-contain mb-1 mt-1 text-center">
        <label style="font-size: larger; color: rgb(7, 59, 58);" for="video_source" class="form-label"><strong>Select video
            source:</strong></label>
        <div class="form-control" style="border: none; padding: 0;">
          <div class="form-check">
            <input type="radio" id="webcam" name="video_source" value="0" class="form-check-input">
            <label for="webcam" class="form-check-label">
              <img width="50" height="50" src="static/images/webcam.svg" alt="Webcam Icon">Webcam
            </label>
          </div>
          <div class="form-check">
            <input type="radio" id="ipCamera" name="video_source" value="1" class="form-check-input">
            <label for="ipCamera" class="form-check-label">
              <img width="50" height="50" src="static/images/cctv.svg" alt="Webcam Icon">CCTV
            </label>
          </div>
          <div class="form-check">
            <input type="radio" id="localFile" name="video_source" value="2" class="form-check-input">
            <label for="localFile" class="form-check-label">
              <img width="50" height="50" src="static/images/file.svg" alt="Webcam Icon">Local File
            </label>
          </div>
        </div>
      </div>
      <div class="tno">
        <div style="width: 50%;" class="mt-1 text-center">
          <label style="font-size: larger;font-weight: bold; color: rgb(7, 59, 58);" id="number" for="totalCount">Total Number of Animals in
            Farm:</label>
          <input placeholder="Enter number" type="number" class="form-control " id="totalCount" name="totalCount" min="0"> <br>
        </div>
      </div>
    </div>
  </div>
  <div id="errorMessage" style="display: none; color: red; text-align: center;">
    Please select a video source.
  </div>
  <div style="display: flex; justify-content: center;">
    <button style="background-color: rgb(7, 59, 58);" type="submit" class="btn btn-dark m-2" value="submit" id="btn1">Start</button>
    <button style="background-color: rgb(7, 59, 58);" type="button" class="btn btn-dark m-2" id="btn3" onclick="hidefeed()">Hide Video</button>
    <button style="background-color: rgb(7, 59, 58);" type="button" class="btn btn-dark m-2" id="btn2" onclick="end()">End</button>
  </div>
</form>

<!-- real-time data display -->

<div class="container border border-dark rounded my-5 text-center" id="todocont"
  style="background-color: rgba(255, 255, 255, 0.8);">

  <!-- real-time animal-counting -->

  <h1 class="mt-5" style="padding-bottom: 0;">Farm Data</h1>



  <table class="table table-hover">
    <thead>
      <tr>
        <th>Video Source</th>
        <th>Farm</th>
        <!-- <th>Animal type</th> -->
        <th>In Farm</th>
        <th id="animal">Number Of Animals in Farm</th>
        <th>Threat detected</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ video_source }}</td>
        <td id="farm">None Selected</td>
        <!-- <td id="type">none</td> -->
        <td id="detections">None</td>
        <td id="count">0</td>
        <td id="threat">None</td>
      </tr>
    </tbody>
  </table>
  <div id="errorMessage" style="display: none; color: rgb(255, 0, 0);padding: 20px 5px; margin-top: 10px;">
    The count has been reduced. Please check the farm!
  </div>
  <div id="threatMessage" style="display: none; color: rgb(255, 0, 0);padding: 20px 5px; margin-top: 10px;">
    A THREAT HAS ENTERED YOUR FARM. PLEASE CHECK YOUR FARM!
  </div>
  <!-- real-time video-feed -->

  <h1 class="mt-5">{{ var2 }}</h1>

  {% if video_source %}
  <img id="data" class="mt-3 mb-3 rounded" src="{{ url_for('video_feed', video_source=video_source)}}" id="videoFeed"
    alt="cctvfotage" width="50%">
  {% endif %}

</div>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

<script>
  document.getElementById('btn1').addEventListener('click', function (event) {
    event.preventDefault(); // Prevent default form submission

    const videoSourceSelected = document.querySelector('input[name="video_source"]:checked');

    if (!videoSourceSelected) {
      document.getElementById('errorMessage').style.display = 'block'; // Show message
    } else {
      // Form is valid; you can proceed with form submission logic
      const form = this.closest('form');
      form.submit();
    }
  });
</script>
<script>
  // Farm value from index.html
  window.onload = function () {
    // Retrieve selected farm from local storage
    const selectedFarm = localStorage.getItem('selectedFarm')


    // Update the table cell
    if (selectedFarm) {
      document.getElementById('farm').textContent = selectedFarm;

      // Update the table heading
      const tableHeading = document.getElementById('animal');
      const Heading = document.getElementById('heading');
      const number = document.getElementById('number');
      const bgimg = document.getElementById('bgimg');

      if (tableHeading && selectedFarm !== "-") {
        tableHeading.textContent = `Number Of ${selectedFarm}'s in Farm`;
        Heading.textContent = `${selectedFarm} Farm`;
        number.textContent = `Total Number of ${selectedFarm}'s in Farm: `;
        bgimg.src = `static/images/${selectedFarm.toLowerCase()}-background.jpg`;
      }

      // Retrieve the total count from local storage
      const storedValue = localStorage.getItem('totalCount');
      if (storedValue) {
        totalCount.value = storedValue;
      }

    }
    initializeEmailJS('evxSca2OAo-6_8rHD'); // Replace with your actual EmailJS User ID

  };

  // Showing or Hiding video-feed

  function hidefeed() {
    var live_feed = document.getElementById('videoFeed')
    var btn3 = document.getElementById('btn3')

    if (live_feed.style.display == "none") {
      live_feed.style.display = "block";
      live_feed.style.marginLeft = "auto";
      live_feed.style.marginRight = "auto"
      btn3.innerHTML = "Hide Video"
    }
    else {
      live_feed.style.display = "none";
      btn3.innerHTML = "Show Video"
    }
  }

  function end(){
    window.location.href = "/";
  }


  var video_source = "{{ video_source }}";

  // Store the total count in localStorage when start button is clicked
  document.getElementById('btn1').addEventListener('click', function () {
    const totalCountInput = document.getElementById('totalCount');
    const storedValue = totalCountInput.value;

    // store value in localStorage:
    localStorage.setItem('totalCount', storedValue);
    console.log(storedValue)
  });

  var isCountReducedTimerActive = false;
  var countReductionTimeout;



  // starts only when the video is on
  if (video_source == "0" || video_source == "1" || video_source == "2") {
    document.getElementById('data').scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });;
    function updateinfo() {
      var videoFeed = document.getElementById('videoFeed');
      if (videoFeed) {
        videoFeed.src = "{{ url_for('video_feed', video_source=video_source)}}";
      }
    }
  } else {
    console.log("Video is off. No updates to count, type, or threat.");
  }
  // Call updateinfo every 500 milliseconds (0.5 seconds)
  setInterval(updateinfo, 500);

  // -------------------------------------------------socketio------------------------------------------------------------//
  var socket = io.connect('http://' + document.domain + ':' + location.port);
  console.log("connected to socket")

  // COUNT UPDATION
  socket.on('animal_count_update', function (data) {
    document.getElementById('count').innerHTML = data.count;
    const totalCountInput = document.getElementById('totalCount');
    const storedValue = totalCountInput.value;

    if (data.count < storedValue) {
      if (!isCountReducedTimerActive) {
        isCountReducedTimerActive = true;
        // Start a timer of 5 seconds before logging and showing the error message
        countReductionTimeout = setTimeout(function () {
          console.log("count reduced");
          // sendAlertEmail("Animal count has reduced! Please check the farm.");
          document.getElementById('errorMessage').style.display = "block"; // Show the error message
          isCountReducedTimerActive = false;
        }, 5000);
      }
    } else {
      // If current count is not less than storedValue, reset the timer and hide the error message
      if (isCountReducedTimerActive) {
        clearTimeout(countReductionTimeout);
        document.getElementById('errorMessage').style.display = "none"; // Hide the error message
        isCountReducedTimerActive = false;
      } else if (data.count == storedValue) {
        // If the current count is exactly equal to the stored value, ensure the error message is hidden
        document.getElementById('errorMessage').style.display = "none";
      }
    }

    console.log("recieved count")
  });

  // DETECTION UPDATION
  socket.on('detections_update', function (data) {
    document.getElementById('detections').innerHTML = data.detections;
    console.log("recieved detections")
  });

  // THREAT UPDATION
  socket.on('threat_update', function (data) {
    document.getElementById('threat').innerHTML = data.threat;
    const threatclass = data.threat;
    if (threatclass !== "None") {
      document.getElementById('threatMessage').style.display = "block";
      document.getElementById('threat').innerHTML = data.threat;

      // Start the threat timer if it's not already running
      if (!threatTimer) {
        threatTimer = setTimeout(function () {
          const currentTime = getCurrentFormattedTime();
          sendAlertEmail(`Threat (${threatclass}) detected in the farm at ${currentTime}. Please check the farm!`);
          // Reset the timer
        }, threatAlertDelay);
      }

    } else {
      document.getElementById('threatMessage').style.display = "none";
      document.getElementById('threat').innerHTML = "none";

      // If there is no threat, clear the timer (if running)
      if (threatTimer) {
        clearTimeout(threatTimer);
        threatTimer = null;
      }
    }
    console.log("recieved threat")
  });



  // -------------------------------------------------------------------------------------------------------------//

  function getCurrentFormattedTime() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const seconds = now.getSeconds();

    // Optionally add AM/PM if needed
    const timeOfDay = hours >= 12 ? 'PM' : 'AM';
    const adjustedHours = hours % 12 || 12;  // For 12-hour clock

    // You can customize formatting as needed
    return `${adjustedHours}:${minutes}:${seconds} ${timeOfDay}`;
  }
  // -------------------------------------------------------------------------------------------------------------//
  // Initialize EmailJS (replace with your actual User ID)
  function initializeEmailJS(userID) {
    emailjs.init(userID);
  }

  // Function to send an alert email
  function sendAlertEmail(message) {
    const templateParams = {
      message: message
    };

    emailjs.send('service_6npikfr', 'template_pfo1dry', templateParams)
      .then(function (response) {
        console.log('SUCCESS!', response.status, response.text);
      }, function (error) {
        console.log('FAILED...', error);
      });
  }

  // Variables for threat detection and timer
  let threatTimer = null;
  const threatAlertDelay = 10000; // 10 seconds 
</script>

{% endblock body %}